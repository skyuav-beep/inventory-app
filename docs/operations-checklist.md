# 운영 체크리스트

재고 관리 서비스 운영 중 발생할 수 있는 주요 시나리오에 대해 아래 항목을 점검하세요.

## 1. 사전 점검 (릴리즈 전)

- [ ] **환경 변수 검증**: `.env`와 `apps/api/.env`에 DB/JWT/텔레그램 토큰 등 필수 값이 설정되어 있는지 확인합니다.
- [ ] **헬스 체크**: `/api/v1/health` 호출 시 `status=ok`를 반환하는지 확인합니다.
- [ ] **레이트 리밋 설정 확인**: `THROTTLE_DEFAULT_*` 환경 변수를 점검하고, `/auth/login`, `/alerts/*` 엔드포인트에 과도한 호출 제한이 필요한지 재확인합니다.
- [ ] **Prisma 마이그레이션**: `npm --workspace apps/api run prisma:migrate:deploy` 실행 후 스키마 버전과 `migration_lock.toml` 상태를 점검합니다.
- [ ] **시드 데이터**: `npm --workspace apps/api run prisma:seed` 실행으로 관리자 계정과 기본 설정 생성 여부를 확인합니다.
- [ ] **컨테이너 구성 점검**: `infra/docker-compose.yml` 기반으로 `docker compose config`를 실행해 환경변수와 포트 매핑이 기대대로 되는지 확인합니다.

## 2. 배포 직후 점검

- [ ] **관리자 로그인**: 시드된 관리자 계정으로 웹 UI에 로그인 후 주요 페이지가 정상 렌더링되는지 확인합니다.
- [ ] **주요 기능 스모크 테스트**: 제품 CRUD, 입고/출고/반품 등록, 업로드 큐 등록을 실행해 API 응답과 이벤트 로그를 확인합니다.
- [ ] **텔레그램 알림 검증**: `/api/v1/alerts/test` 호출 혹은 설정 화면에서 테스트 발송을 실행해 큐/재시도 로그가 생성되는지 확인합니다.
- [ ] **감사 로그 확인**: `audit_logs` 테이블에서 최근 이벤트(제품/입고/출고/반품/사용자 생성)가 기록되는지 확인합니다.
- [ ] **인프라 모니터링 연계**: 헬스 체크 엔드포인트와 로그 수집(예: CloudWatch, ELK, Loki)을 연결해 경보(Alert)를 설정합니다.

## 3. 운영 중 대응 절차

### 3.1 장애 대응

1. **헬스 체크 확인**: `/api/v1/health` 결과로 DB 연결/지연시간을 확인합니다. `status=degraded`일 경우 `services.database` 항목을 확인합니다.
2. **로그 조회**: Nest 전역 로거(HTTP/Errors)와 감사 로그를 통해 장애 시점의 요청/사용자 정보를 확인합니다.
3. **큐 상태 점검**: 업로드 워커(`upload_jobs`)와 알림 워커(`audit_logs`, `alerts`의 `retryAt`) 상태를 확인합니다.
4. **Roll-back / 재배포**: 장애 원인이 코드라면 `git` 태그를 활용해 이전 버전으로 롤백하거나 새 패치를 적용합니다.

### 3.2 백업 & 복구

- [ ] PostgreSQL 백업 스케줄이 정의되어 있는지 확인합니다(예: `pg_dump` + S3, RDS 백업 등).
- [ ] 백업 복구 연습을 정기적으로 수행해 스키마/데이터가 정상 복구되는지 검증합니다.
- [ ] 복구 시 `.env`의 DB 접속 정보 변경 여부와 Prisma 마이그레이션 적용 순서를 확인합니다.

### 3.3 보안 점검

- [ ] 관리자 계정 비밀번호 교체 정책 및 2FA 여부를 정기적으로 점검합니다.
- [ ] 텔레그램 토큰 변경 시 `notification_settings`와 `.env`에 저장된 값을 동기화합니다.
- [ ] 감사 로그(`audit_logs`)에서 비정상적인 CRUD 요청이나 반복적인 로그인 시도를 확인 후 대응합니다.

## 4. 모니터링 지표 제안

| 범주            | 지표/이벤트                                 | 임계값/대응                                    |
| ---------------- | ------------------------------------------- | ---------------------------------------------- |
| 애플리케이션     | `/health` 응답 시간, HTTP 5xx/4xx 비율      | 5분 평균 지연 1초 이상, 5xx > 1% 시 경보      |
| 알림 워커        | `alerts.retryAt` 미전송 건수, 재시도 횟수  | 재시도 5회 이상 또는 30분 이상 미발송 시 경보 |
| 업로드 워커      | `upload_jobs` 상태(queued/processing)      | queued 10건 이상 지속 시 확인                 |
| DB               | CPU/메모리 사용량, 연결 수, 느린 쿼리      | 서비스 수준에 맞는 임계치 설정                |
| 감사 로그        | `AuditAction.login` 실패/비정상 패턴       | 일정 횟수 초과 시 보안 담당자에 통보          |

## 5. 릴리즈 이후 정기 점검

- [ ] 월 1회 이상 알림/업로드 워커 및 예약 작업이 정상 동작하는지 통합 테스트를 수행합니다.
- [ ] Prisma 마이그레이션 누락, DB 스키마 차이를 `prisma migrate status`로 점검합니다.
- [ ] README/문서/환경 변수 템플릿이 최신 상태인지 검토합니다.

위 체크리스트는 프로젝트 진행 상황에 따라 지속적으로 보강해야 합니다. 개선 아이디어나 운영 이슈가 발견되면 PR/문서화로 공유해주세요.
